/**
 * Generate SQL migration 010 to reseed browse_items from the extracted HTML data.
 *
 * Usage: node scripts/generate-browse-migration.js
 * Output: migrations/010_reseed_browse_items.sql
 */

const fs = require('fs');
const path = require('path');

const data = JSON.parse(
  fs.readFileSync(path.join(__dirname, '..', 'data', 'browse-doa-data.json'), 'utf-8')
);

// SQL-escape a string value (single-quote escaping)
function esc(val) {
  if (val === null || val === undefined || val === '') return 'NULL';
  return "'" + String(val).replace(/'/g, "''") + "'";
}

// Derive parent_code from code (strip last dot-segment)
function parentCode(code) {
  const idx = code.lastIndexOf('.');
  if (idx === -1) return null;
  return code.substring(0, idx);
}

const lines = [];

lines.push('-- Migration 010: Reseed browse_items from original HTML data (485 items)');
lines.push('-- Generated by scripts/generate-browse-migration.js');
lines.push('');

// Step 1: Add missing roles
lines.push('-- Step 1: Add missing roles and fix name mismatch');
lines.push("UPDATE roles SET name = 'PSL/EPF Finance Controller' WHERE name = 'PSL/CoE/EPF Finance Controller';");
const missingRoles = ['Country Payroll', 'ENG/TECH Head', 'Respective CEO N-1', 'Support Function Head', 'Technology Portfolio Head'];
for (const role of missingRoles) {
  lines.push(`INSERT INTO roles (name) VALUES (${esc(role)}) ON CONFLICT (name) DO NOTHING;`);
}
lines.push('');

// Step 2: Clear old browse data
lines.push('-- Step 2: Clear old browse data');
lines.push('DELETE FROM browse_item_approvers;');
lines.push('DELETE FROM browse_items;');
lines.push('');

// Step 3: Insert all 485 items
lines.push('-- Step 3: Insert all browse items');
for (let i = 0; i < data.length; i++) {
  const item = data[i];
  const pc = parentCode(item.code);
  lines.push(
    `INSERT INTO browse_items (code, parent_code, title, description, comments, function_name, sort_order) VALUES (${esc(item.code)}, ${esc(pc)}, ${esc(item.title)}, ${esc(item.description)}, ${esc(item.comments)}, ${esc(item.function)}, ${i + 1});`
  );
}
lines.push('');

// Step 4: Insert approval chain entries
// NOTE: We use sort_order (unique per item) to look up browse_item_id
// because some items share the same code (e.g. "1.2.1" appears multiple times).
lines.push('-- Step 4: Insert approval chain entries');
lines.push('-- Using sort_order to uniquely identify items (codes can be duplicated)');
for (let i = 0; i < data.length; i++) {
  const item = data[i];
  if (!item.approvalChain || item.approvalChain.length === 0) continue;
  const sortOrder = i + 1; // matches the sort_order assigned in Step 3
  for (let j = 0; j < item.approvalChain.length; j++) {
    const ac = item.approvalChain[j];
    lines.push(
      `INSERT INTO browse_item_approvers (browse_item_id, role_id, action, kind, sort_order) VALUES ((SELECT id FROM browse_items WHERE sort_order = ${sortOrder}), (SELECT id FROM roles WHERE name = ${esc(ac.role)}), ${esc(ac.action)}, ${esc(ac.kind)}, ${j + 1});`
    );
  }
}

const output = lines.join('\n') + '\n';
const outPath = path.join(__dirname, '..', 'migrations', '010_reseed_browse_items.sql');
fs.writeFileSync(outPath, output, 'utf-8');
console.log(`Generated: ${outPath}`);
console.log(`Total lines: ${lines.length}`);
console.log(`Browse items: ${data.length}`);

// Count approval chain entries
let acCount = 0;
for (const item of data) {
  if (item.approvalChain) acCount += item.approvalChain.length;
}
console.log(`Approval chain entries: ${acCount}`);
